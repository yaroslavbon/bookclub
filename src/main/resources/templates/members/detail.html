<!-- src/main/resources/templates/members/detail.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/main :: html(content=~{::content}, scripts=~{::scripts}, title='Member Details')}">
<head>
    <title>Member Details</title>
</head>
<body>
<th:block th:fragment="content">
    <div class="bg-white rounded-lg shadow-md mb-4 overflow-hidden">
        <div class="px-4 py-2 border-b d-flex justify-content-between align-items-center">
            <h3 class="fs-5 fw-semibold mb-0">
                Member Details: <span th:text="${member.name}">Member Name</span>
            </h3>
            <a th:href="@{/members}" class="btn btn-outline-primary btn-sm">Back to Members</a>
        </div>

        <div class="p-4">
            <div class="row">
                <div class="col-md-6">
                    <form th:action="@{/members/{id}(id=${member.id})}" method="post">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" name="name"
                                   th:value="${member.name}" required>
                        </div>

                        <div class="mb-3 d-flex gap-2">
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                            <button type="button" class="btn btn-outline-danger"
                                    data-bs-toggle="modal" data-bs-target="#deleteMemberModal">
                                Delete Member
                            </button>
                        </div>
                    </form>
                </div>

                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-header bg-light">
                            <h5 class="card-title fs-6 fw-semibold mb-0">Queue Status</h5>
                        </div>
                        <div class="card-body" id="queueStatusCard">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header bg-light">
                            <h5 class="card-title fs-6 fw-semibold mb-0">Member Statistics</h5>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush" id="memberStats">
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Books on Wishlist
                                    <span class="badge bg-primary rounded-pill" id="wishlistCount">
                                        <span class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </span>
                                    </span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Books Completed
                                    <span class="badge bg-success rounded-pill" id="completedCount">
                                        <span class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </span>
                                    </span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    Times Selected
                                    <span class="badge bg-info rounded-pill" id="picksCount">
                                        <span class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </span>
                                    </span>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Member's Books Section -->
            <div class="mt-4" id="memberBooksSection">
                <h4 class="fs-5 fw-semibold mb-3">Member's Books</h4>
                <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteMemberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete <strong th:text="${member.name}">Member Name</strong>?</p>
                    <p class="text-danger">This action cannot be undone. All their books will be orphaned.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form th:action="@{/members/{id}/delete(id=${member.id})}" method="post">
                        <button type="submit" class="btn btn-danger">Delete Member</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block th:fragment="scripts">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Check queue status and load member statistics
            checkQueueStatus();
            loadMemberBooks();
            loadMemberStatistics();
        });

        function checkQueueStatus() {
            const queueStatusCard = document.getElementById('queueStatusCard');
            const memberId = [[${member.id}]];
            const memberName = [[${member.name}]];

            // Fetch queue information
            fetch(contextPath + '/queue')
                .then(response => response.text())
                .then(html => {
                    // Create a temporary element to parse the HTML
                    const tempElement = document.createElement('div');
                    tempElement.innerHTML = html;

                    // Extract members in queue
                    const queueTable = tempElement.querySelector('table');
                    let memberInQueue = false;
                    let queuePosition = null;
                    let isActive = false;

                    if (queueTable) {
                        const rows = queueTable.querySelectorAll('tbody tr');
                        rows.forEach((row, index) => {
                            // This assumes the member name is in the second cell
                            const rowMemberName = row.cells[1]?.textContent?.trim();
                            if (rowMemberName === memberName) {
                                memberInQueue = true;
                                queuePosition = index;

                                // Check if active (5th column should have "Active" text)
                                isActive = row.cells[4]?.textContent?.trim().includes("Active");
                            }
                        });
                    }

                    // Update queue status card
                    if (memberInQueue) {
                        let statusHtml = '<div class="alert alert-success mb-3">';
                        statusHtml += '<strong>In Queue</strong>';

                        if (queuePosition === 0) {
                            statusHtml += ' - Currently selecting';
                        } else if (queuePosition === 1) {
                            statusHtml += ' - Next in line';
                        } else {
                            statusHtml += ` - Position #${queuePosition + 1}`;
                        }

                        if (!isActive) {
                            statusHtml += ' (Inactive)';
                        }

                        statusHtml += '</div>';

                        statusHtml += '<form action="' + contextPath + '/members/' + memberId + '/remove-from-queue" method="post">';
                        statusHtml += '<button type="submit" class="btn btn-outline-danger btn-sm">Remove from Queue</button>';
                        statusHtml += '</form>';

                        queueStatusCard.innerHTML = statusHtml;
                    } else {
                        queueStatusCard.innerHTML = '<div class="alert alert-secondary mb-3">Not in Queue</div>' +
                            '<form action="' + contextPath + '/members/' + memberId + '/add-to-queue" method="post">' +
                            '<button type="submit" class="btn btn-outline-success btn-sm">Add to Queue</button>' +
                            '</form>';
                    }
                })
                .catch(error => {
                    console.error('Error checking queue status:', error);
                    queueStatusCard.innerHTML = '<div class="alert alert-danger">Error loading queue status</div>';
                });
        }

        function loadMemberBooks() {
            const memberBooksSection = document.getElementById('memberBooksSection');
            const memberId = [[${member.id}]];

            // Fetch books for this member
            fetch(contextPath + '/books?ownerId=' + memberId)
                .then(response => response.text())
                .then(html => {
                    // Create a temporary element to parse the HTML
                    const tempElement = document.createElement('div');
                    tempElement.innerHTML = html;

                    // Extract the book list content
                    const booksList = tempElement.querySelector('.list-group');

                    if (booksList && booksList.children.length > 0) {
                        memberBooksSection.innerHTML = '<h4 class="fs-5 fw-semibold mb-3">Member\'s Books</h4>';
                        memberBooksSection.appendChild(booksList);
                    } else {
                        memberBooksSection.innerHTML = '<h4 class="fs-5 fw-semibold mb-3">Member\'s Books</h4>' +
                            '<div class="alert alert-light">' +
                            '<p class="mb-0">This member has not added any books yet.</p>' +
                            '</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading member books:', error);
                    memberBooksSection.innerHTML = '<h4 class="fs-5 fw-semibold mb-3">Member\'s Books</h4>' +
                        '<div class="alert alert-danger">Error loading books</div>';
                });
        }

        function loadMemberStatistics() {
            const wishlistCount = document.getElementById('wishlistCount');
            const completedCount = document.getElementById('completedCount');
            const picksCount = document.getElementById('picksCount');
            const memberId = [[${member.id}]];

            // This would ideally be an API endpoint that returns statistics for the member
            // For now, we'll simulate by counting books from the books page
            fetch(contextPath + '/books?ownerId=' + memberId)
                .then(response => response.text())
                .then(html => {
                    // Create a temporary element to parse the HTML
                    const tempElement = document.createElement('div');
                    tempElement.innerHTML = html;

                    // Count books by status
                    let wishlistBooks = 0;
                    let completedBooks = 0;

                    const books = tempElement.querySelectorAll('.list-group-item');
                    books.forEach(book => {
                        const statusBadge = book.querySelector('.badge');
                        if (statusBadge) {
                            const status = statusBadge.textContent.trim();
                            if (status === 'Wishlist') {
                                wishlistBooks++;
                            } else if (status === 'Completed') {
                                completedBooks++;
                            }
                        }
                    });

                    wishlistCount.textContent = wishlistBooks;
                    completedCount.textContent = completedBooks;

                    // For picks count, we need to check the queue
                    fetch(contextPath + '/queue')
                        .then(response => response.text())
                        .then(html => {
                            const tempElement = document.createElement('div');
                            tempElement.innerHTML = html;

                            const memberName = [[${member.name}]];
                            let picksCountValue = 0;

                            const queueTable = tempElement.querySelector('table');
                            if (queueTable) {
                                const rows = queueTable.querySelectorAll('tbody tr');
                                rows.forEach(row => {
                                    const rowMemberName = row.cells[1]?.textContent?.trim();
                                    if (rowMemberName === memberName) {
                                        // Picks count should be in the 4th column
                                        picksCountValue = parseInt(row.cells[3]?.textContent?.trim()) || 0;
                                    }
                                });
                            }

                            picksCount.textContent = picksCountValue;
                        })
                        .catch(error => {
                            console.error('Error loading picks count:', error);
                            picksCount.textContent = 'Error';
                        });
                })
                .catch(error => {
                    console.error('Error loading member statistics:', error);
                    wishlistCount.textContent = 'Error';
                    completedCount.textContent = 'Error';
                });
        }
    </script>
</th:block>
</body>
</html>