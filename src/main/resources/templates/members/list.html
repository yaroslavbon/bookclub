<!-- src/main/resources/templates/members/list.html -->
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      th:replace="~{layouts/main :: html(content=~{::content}, scripts=~{::scripts}, title='Members')}">
<head>
    <title>Members</title>
</head>
<body>
<th:block th:fragment="content">
    <!-- Members List -->
    <div class="bg-white rounded-lg shadow-md mb-4 overflow-hidden">
        <div class="px-4 py-2 border-b d-flex justify-content-between align-items-center">
            <h3 class="fs-5 fw-semibold mb-0">Book Club Members</h3>
            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addMemberModal">
                Add Member
            </button>
        </div>

        <div class="p-4">
            <div th:if="${#lists.isEmpty(members)}" class="alert alert-light">
                <p class="mb-0">No members have been added yet.</p>
            </div>

            <div th:unless="${#lists.isEmpty(members)}" class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                    <tr>
                        <th>Name</th>
                        <th>Books Owned</th>
                        <th>Queue Status</th>
                        <th>Actions</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="member : ${members}">
                        <td class="fw-medium" th:text="${member.name}">Member Name</td>
                        <td>
                            <!-- This requires additional functionality to count books per member -->
                            <!-- For now, we'll use a placeholder -->
                            <span class="badge bg-secondary">View Books</span>
                        </td>
                        <td>
                            <!-- This needs to be populated based on whether the member is in the queue -->
                            <!-- For now, we'll use a placeholder that will be updated via JavaScript -->
                            <span th:attr="data-member-id=${member.id}" class="queue-status">
                                    <span class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </span>
                                </span>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm">
                                <a th:href="@{/members/{id}(id=${member.id})}" class="btn btn-outline-primary">
                                    Edit
                                </a>
                                <button type="button" class="btn btn-outline-danger"
                                        th:attr="data-member-id=${member.id}, data-member-name=${member.name}"
                                        onclick="confirmDeleteMember(this)">
                                    Delete
                                </button>
                                <!-- Queue actions buttons will be added dynamically -->
                                <button type="button" class="btn btn-outline-secondary queue-action-btn"
                                        th:attr="data-member-id=${member.id}" style="display: none">
                                    Queue Action
                                </button>
                            </div>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Add Member Modal -->
    <div class="modal fade" id="addMemberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Member</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form th:action="@{/members}" method="post">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="name" class="form-label">Name</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3 form-check">
                            <input type="checkbox" class="form-check-input" id="addToQueue" name="addToQueue" checked>
                            <label class="form-check-label" for="addToQueue">Add to reading queue</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Add Member</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteMemberModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete the member "<span id="deleteMemberName"></span>"?</p>
                    <p class="text-danger">This action cannot be undone. All their books will be orphaned.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form id="deleteMemberForm" method="post">
                        <button type="submit" class="btn btn-danger">Delete Member</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</th:block>

<th:block th:fragment="scripts">
    <script>

        document.addEventListener('DOMContentLoaded', function() {
            // Check queue status for each member and update UI
            checkQueueStatus();

            // Set up delete confirmation modal
            const deleteModal = document.getElementById('deleteMemberModal');
            if (deleteModal) {
                deleteModal.addEventListener('show.bs.modal', function(event) {
                    const button = event.relatedTarget;
                    const memberId = button.getAttribute('data-member-id');
                    const memberName = button.getAttribute('data-member-name');

                    // Update the modal's content
                    const nameSpan = document.getElementById('deleteMemberName');
                    if (nameSpan) nameSpan.textContent = memberName;

                    const form = document.getElementById('deleteMemberForm');
                    if (form) form.setAttribute('action', `${contextPath}/members/${memberId}/delete`);
                });
            }
        });

        function confirmDeleteMember(button) {
            const memberId = button.getAttribute('data-member-id');
            const memberName = button.getAttribute('data-member-name');

            // Set up the modal
            const nameSpan = document.getElementById('deleteMemberName');
            if (nameSpan) nameSpan.textContent = memberName;

            const form = document.getElementById('deleteMemberForm');
            if (form) form.setAttribute('action', `${contextPath}/members/${memberId}/delete`);

            // Show the modal
            const modal = new bootstrap.Modal(document.getElementById('deleteMemberModal'));
            modal.show();
        }

        function checkQueueStatus() {
            const statusElements = document.querySelectorAll('.queue-status');

            // Create a Set of all member IDs
            const memberIds = new Set();
            statusElements.forEach(el => {
                const memberId = el.getAttribute('data-member-id');
                if (memberId) memberIds.add(memberId);
            });

            // Fetch queue information
            fetch(contextPath + '/queue')
                .then(response => response.text())
                .then(html => {
                    // Create a temporary element to parse the HTML
                    const tempElement = document.createElement('div');
                    tempElement.innerHTML = html;

                    // Extract members in queue
                    const queueTable = tempElement.querySelector('table');
                    const membersInQueue = new Set();

                    if (queueTable) {
                        const rows = queueTable.querySelectorAll('tbody tr');
                        rows.forEach(row => {
                            // This assumes the member name is in the second cell
                            // and we'll use it to match with members
                            const memberName = row.cells[1]?.textContent?.trim();
                            if (memberName) membersInQueue.add(memberName);
                        });
                    }

                    // Update status for each member
                    document.querySelectorAll('.queue-status').forEach(el => {
                        const memberId = el.getAttribute('data-member-id');
                        const memberName = el.closest('tr').cells[0].textContent.trim();

                        if (membersInQueue.has(memberName)) {
                            el.innerHTML = '<span class="badge bg-success">In Queue</span>';

                            // Update queue action button
                            const actionBtn = el.closest('tr').querySelector('.queue-action-btn');
                            if (actionBtn) {
                                actionBtn.style.display = 'inline-block';
                                actionBtn.classList.add('btn-outline-danger');
                                actionBtn.classList.remove('btn-outline-success');
                                actionBtn.textContent = 'Remove from Queue';
                                actionBtn.onclick = function() {
                                    removeFromQueue(memberId);
                                };
                            }
                        } else {
                            el.innerHTML = '<span class="badge bg-secondary">Not in Queue</span>';

                            // Update queue action button
                            const actionBtn = el.closest('tr').querySelector('.queue-action-btn');
                            if (actionBtn) {
                                actionBtn.style.display = 'inline-block';
                                actionBtn.classList.add('btn-outline-success');
                                actionBtn.classList.remove('btn-outline-danger');
                                actionBtn.textContent = 'Add to Queue';
                                actionBtn.onclick = function() {
                                    addToQueue(memberId);
                                };
                            }
                        }
                    });
                })
                .catch(error => {
                    console.error('Error checking queue status:', error);
                    // Show error state
                    document.querySelectorAll('.queue-status').forEach(el => {
                        el.innerHTML = '<span class="badge bg-danger">Error</span>';
                    });
                });
        }

        function addToQueue(memberId) {
            // Create and submit a form to add the member to the queue
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `${contextPath}/members/${memberId}/add-to-queue`;
            document.body.appendChild(form);
            form.submit();
        }

        function removeFromQueue(memberId) {
            // Create and submit a form to remove the member from the queue
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = `${contextPath}/members/${memberId}/remove-from-queue`;
            document.body.appendChild(form);
            form.submit();
        }
    </script>
</th:block>
</body>
</html>